<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GrammarPro - Chuy√™n Gia Ng·ªØ Ph√°p</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google GenAI SDK -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>

    <style>
      body { font-family: 'Quicksand', sans-serif; background-color: #f0f9ff; }
      .animate-slide-up { animation: slideUp 0.5s ease-out; }
      @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      
      .glass-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import { GoogleGenAI, Type } from "@google/genai";
      const { useState, useEffect, useRef } = React;

      // ============================================================================
      // C·∫§U H√åNH H·ªÜ TH·ªêNG
      // ============================================================================
      const _sysConfig = {
          // üëá D√ÅN KEY C·ª¶A B·∫†N V√ÄO D√íNG D∆Ø·ªöI ƒê√ÇY üëá
          authToken: 'PASTE_YOUR_KEY_HERE', 
      };

      const getAuthToken = () => {
          const t = _sysConfig.authToken;
          if (!t || t === 'PASTE_YOUR_KEY_HERE' || t.length < 10) return null;
          return t;
      };

      // --- AI SERVICE ---
      let aiInstance = null;
      const token = getAuthToken();
      if (token) {
          aiInstance = new GoogleGenAI({ apiKey: token });
      }

      const generateGrammarLesson = async (topic) => {
        if (!aiInstance) throw new Error("Ch∆∞a nh·∫≠p API Key");

        const model = "gemini-2.5-flash";
        const prompt = `
          Act as a friendly, expert English Grammar Teacher for middle school students.
          Topic: "${topic}".
          
          Generate a detailed lesson and interactive exercises.
          Output JSON format:
          {
            "title": "Topic Title in Vietnamese",
            "theory": [
              {
                "heading": "Section Title",
                "content": "Detailed explanation in Vietnamese, friendly tone.",
                "examples": [
                   {"en": "English example 1", "vi": "Vietnamese translation 1"}
                ]
              }
            ],
            "exercises": [
              {
                "id": "1",
                "type": "choice", 
                "question": "Question text",
                "options": ["A", "B", "C", "D"],
                "answer": "Correct Option Content",
                "explanation": "Why is it correct (Vietnamese)"
              },
              {
                "id": "2",
                "type": "true_false",
                "question": "Statement text",
                "options": ["True", "False"],
                "answer": "True", 
                "explanation": "Why (Vietnamese)"
              },
              {
                "id": "3",
                "type": "fill",
                "question": "Sentence with ___ blank.",
                "hint": "verb/clue",
                "answer": "correct_word",
                "explanation": "Why (Vietnamese)"
              },
              {
                "id": "4",
                "type": "error",
                "question": "Sentence with a wrong word.",
                "answer": "wrong_word",
                "correction": "correct_word",
                "explanation": "Why (Vietnamese)"
              },
               {
                "id": "5",
                "type": "reorder",
                "question": "Make a correct sentence",
                "words": ["I", "go", "to", "school"],
                "answer": "I go to school",
                "explanation": "Structure explanation"
              }
            ]
          }
          Generate at least 8 exercises, mixing types. Ensure 'reorder' type has 'words' array shuffled.
        `;

        const response = await aiInstance.models.generateContent({
          model,
          contents: prompt,
          config: {
            responseMimeType: "application/json",
             responseSchema: {
                type: Type.OBJECT,
                properties: {
                  title: { type: Type.STRING },
                  theory: {
                    type: Type.ARRAY,
                    items: {
                      type: Type.OBJECT,
                      properties: {
                        heading: { type: Type.STRING },
                        content: { type: Type.STRING },
                        examples: {
                          type: Type.ARRAY,
                          items: {
                            type: Type.OBJECT,
                            properties: { en: { type: Type.STRING }, vi: { type: Type.STRING } }
                          }
                        }
                      }
                    }
                  },
                  exercises: {
                    type: Type.ARRAY,
                    items: {
                      type: Type.OBJECT,
                      properties: {
                        id: { type: Type.STRING },
                        type: { type: Type.STRING, enum: ["choice", "true_false", "fill", "error", "reorder"] },
                        question: { type: Type.STRING },
                        options: { type: Type.ARRAY, items: { type: Type.STRING } },
                        words: { type: Type.ARRAY, items: { type: Type.STRING } },
                        hint: { type: Type.STRING },
                        answer: { type: Type.STRING },
                        correction: { type: Type.STRING },
                        explanation: { type: Type.STRING }
                      }
                    }
                  }
                }
             }
          }
        });

        return JSON.parse(response.text);
      };

      // --- COMPONENTS ---

      const Loading = () => (
        <div className="flex flex-col items-center justify-center py-20">
          <div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
          <p className="text-blue-600 font-bold animate-pulse">C√¥ gi√°o AI ƒëang so·∫°n b√†i gi·∫£ng...</p>
        </div>
      );

      // --- THEORY PANEL ---
      const TheoryPanel = ({ data }) => {
        return (
          <div className="h-full overflow-y-auto p-6 bg-white rounded-l-2xl custom-scrollbar">
            <h2 className="text-2xl font-bold text-blue-800 mb-6 border-b-2 border-blue-100 pb-2">
              üìö L√Ω Thuy·∫øt: {data.title}
            </h2>
            <div className="space-y-8">
              {data.theory.map((section, idx) => (
                <div key={idx} className="animate-slide-up" style={{animationDelay: `${idx * 0.1}s`}}>
                  <h3 className="text-lg font-bold text-indigo-700 mb-2 flex items-center gap-2">
                    <span className="bg-indigo-100 w-8 h-8 rounded-full flex items-center justify-center text-sm">{idx + 1}</span>
                    {section.heading}
                  </h3>
                  <div className="text-gray-700 leading-relaxed mb-4 text-base text-justify">
                    {section.content}
                  </div>
                  {section.examples && section.examples.length > 0 && (
                    <div className="bg-orange-50 rounded-xl p-4 border border-orange-100">
                      <p className="text-xs font-bold text-orange-400 uppercase mb-2">V√≠ d·ª• minh h·ªça:</p>
                      <ul className="space-y-3">
                        {section.examples.map((ex, i) => (
                          <li key={i} className="flex flex-col">
                            <span className="font-semibold text-blue-900">üá¨üáß {ex.en}</span>
                            <span className="text-gray-500 italic text-sm">üáªüá≥ {ex.vi}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        );
      };

      // --- EXERCISE PANEL ---
      const ExercisePanel = ({ exercises }) => {
        const [currentIndex, setCurrentIndex] = useState(0);
        const [userAnswer, setUserAnswer] = useState("");
        const [status, setStatus] = useState("idle"); // idle, correct, incorrect
        const [score, setScore] = useState(0);
        const [showResult, setShowResult] = useState(false);
        // reorderUsedIndices: Stores the index of the word from the original 'words' array that has been clicked
        const [reorderUsedIndices, setReorderUsedIndices] = useState([]); 

        const currentEx = exercises[currentIndex];
        const progress = Math.round((currentIndex / exercises.length) * 100);
        const scorePercent = Math.round((score / exercises.length) * 100);

        useEffect(() => {
          resetState();
        }, [currentIndex, exercises]);

        const resetState = () => {
          setUserAnswer("");
          setStatus("idle");
          setReorderUsedIndices([]);
        };

        const handleCheck = () => {
          if (currentEx.type !== 'reorder' && !userAnswer) return;
          if (currentEx.type === 'reorder' && reorderUsedIndices.length === 0) return;

          let isCorrect = false;
          const cleanAns = currentEx.answer.toString().trim().toLowerCase();

          if (currentEx.type === 'reorder') {
             // Construct the sentence from the used indices
             const userSentence = reorderUsedIndices.map(idx => currentEx.words[idx]).join(" ").trim().toLowerCase();
             isCorrect = userSentence === cleanAns;
          } else {
            const cleanUser = userAnswer.toString().trim().toLowerCase();
            isCorrect = cleanUser === cleanAns;
          }

          if (isCorrect) {
            setStatus("correct");
            if (status !== 'incorrect') setScore(s => s + 1);
          } else {
            setStatus("incorrect");
          }
        };

        const handleNext = () => {
          if (currentIndex < exercises.length - 1) {
            setCurrentIndex(prev => prev + 1);
          } else {
            setShowResult(true);
          }
        };

        const handleRetry = () => {
          setStatus("idle");
          setUserAnswer("");
          setReorderUsedIndices([]);
        };

        const toggleReorderWord = (index) => {
           if (status !== 'idle') return;
           if (reorderUsedIndices.includes(index)) {
             setReorderUsedIndices(prev => prev.filter(i => i !== index));
           } else {
             setReorderUsedIndices(prev => [...prev, index]);
           }
        };

        // UI RENDERERS FOR QUESTION TYPES
        const renderQuestionContent = () => {
          switch (currentEx.type) {
            case 'choice':
            case 'true_false':
              return (
                <div className="grid grid-cols-1 gap-3 mt-4">
                  {currentEx.options.map((opt, i) => (
                    <button
                      key={i}
                      onClick={() => status === 'idle' && setUserAnswer(opt)}
                      className={`p-4 rounded-xl border-2 text-left transition-all ${
                        userAnswer === opt 
                          ? 'border-blue-500 bg-blue-50 text-blue-700 font-bold' 
                          : 'border-gray-100 bg-white hover:border-blue-200'
                      } ${status !== 'idle' ? 'opacity-70 cursor-not-allowed' : ''}`}
                    >
                      {opt}
                    </button>
                  ))}
                </div>
              );
            
            case 'fill':
              return (
                <div className="mt-4">
                  <div className="flex flex-wrap items-center gap-2 text-lg font-medium text-gray-700">
                    {currentEx.question.split("___").map((part, i, arr) => (
                      <React.Fragment key={i}>
                        <span>{part}</span>
                        {i < arr.length - 1 && (
                          <input
                            type="text"
                            value={userAnswer}
                            onChange={(e) => setStatus('idle') && setUserAnswer(e.target.value) || setUserAnswer(e.target.value)}
                            disabled={status !== 'idle'}
                            className="border-b-2 border-blue-400 bg-blue-50 px-2 py-1 outline-none text-center w-32 font-bold text-blue-600 focus:bg-white transition-colors"
                            placeholder="?"
                            autoComplete="off"
                          />
                        )}
                      </React.Fragment>
                    ))}
                  </div>
                  {currentEx.hint && <p className="text-sm text-gray-400 mt-2 italic">üí° G·ª£i √Ω: {currentEx.hint}</p>}
                </div>
              );

            case 'error':
               return (
                 <div className="mt-4">
                   <p className="mb-2 text-gray-600">T√¨m t·ª´ sai trong c√¢u:</p>
                   <p className="text-xl font-medium text-gray-800 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                     {currentEx.question}
                   </p>
                   <input
                     type="text"
                     placeholder="Nh·∫≠p t·ª´ b·ªã sai..."
                     value={userAnswer}
                     onChange={(e) => setStatus('idle') && setUserAnswer(e.target.value) || setUserAnswer(e.target.value)}
                     disabled={status !== 'idle'}
                     className="mt-4 w-full p-3 rounded-xl border-2 border-gray-200 focus:border-red-400 outline-none"
                   />
                 </div>
               );

            case 'reorder':
              return (
                <div className="mt-4 space-y-4">
                   {/* Selected Area */}
                   <div className="min-h-[60px] bg-white border-2 border-dashed border-blue-200 rounded-xl p-3 flex flex-wrap gap-2 transition-all">
                      {reorderUsedIndices.length === 0 && <span className="text-gray-400 text-sm select-none">B·∫•m t·ª´ b√™n d∆∞·ªõi ƒë·ªÉ x·∫øp c√¢u...</span>}
                      {reorderUsedIndices.map((originalIndex) => (
                        <button key={originalIndex} onClick={() => toggleReorderWord(originalIndex)} className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-red-100 hover:text-red-600 font-bold shadow-sm animate-slide-up">
                          {currentEx.words[originalIndex]}
                        </button>
                      ))}
                   </div>
                   
                   {/* Source Area */}
                   <div className="flex flex-wrap gap-2 justify-center">
                     {currentEx.words.map((word, index) => {
                        const isUsed = reorderUsedIndices.includes(index);
                        if (isUsed) return null; // Hide if used
                        return (
                          <button 
                            key={index} 
                            onClick={() => toggleReorderWord(index)}
                            className="px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-lg shadow-sm hover:border-blue-400 hover:text-blue-600 transition-all active:scale-95"
                            disabled={status !== 'idle'}
                          >
                            {word}
                          </button>
                        );
                     })}
                   </div>
                </div>
              );
          }
        };

        if (showResult) {
          return (
             <div className="h-full flex flex-col items-center justify-center bg-white rounded-r-2xl p-8 text-center animate-slide-up">
                <div className="w-24 h-24 bg-gradient-to-tr from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-4xl mb-6 shadow-lg text-white">
                   üèÜ
                </div>
                <h2 className="text-3xl font-bold text-gray-800 mb-2">Ho√†n th√†nh!</h2>
                <p className="text-gray-500 mb-6">B·∫°n ƒë√£ l√†m r·∫•t t·ªët.</p>
                
                <div className="bg-gray-50 rounded-2xl p-6 w-full max-w-sm mb-8">
                   <div className="text-sm text-gray-500 uppercase tracking-wide font-bold">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</div>
                   <div className="text-5xl font-extrabold text-blue-600 mt-2">{scorePercent}%</div>
                   <p className="text-gray-400 mt-2">ƒê√∫ng {score}/{exercises.length} c√¢u</p>
                </div>

                <button onClick={() => window.location.reload()} className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 hover:scale-105 transition-all">
                   H·ªçc b√†i m·ªõi
                </button>
             </div>
          );
        }

        return (
          <div className="h-full flex flex-col bg-gray-50 rounded-r-2xl border-l border-gray-200">
            {/* Header */}
            <div className="p-6 bg-white border-b border-gray-100 flex justify-between items-center rounded-tr-2xl">
               <div>
                 <h3 className="font-bold text-gray-800">B√†i t·∫≠p {currentIndex + 1}/{exercises.length}</h3>
                 <div className="w-32 h-2 bg-gray-100 rounded-full mt-2 overflow-hidden">
                    <div className="h-full bg-green-500 transition-all duration-500" style={{ width: `${progress}%` }}></div>
                 </div>
               </div>
               <div className="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-xs font-bold uppercase">
                  {currentEx.type === 'choice' ? 'Tr·∫Øc nghi·ªám' : currentEx.type === 'reorder' ? 'X·∫øp c√¢u' : currentEx.type === 'error' ? 'T√¨m l·ªói' : 'ƒêi·ªÅn t·ª´'}
               </div>
            </div>

            {/* Question Area */}
            <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
               <h4 className="text-xl font-bold text-gray-800 mb-2">{currentEx.question}</h4>
               {renderQuestionContent()}

               {/* Feedback Area */}
               {status !== 'idle' && (
                 <div className={`mt-6 p-4 rounded-xl border-2 ${status === 'correct' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} animate-slide-up`}>
                    <div className="flex items-center gap-2 mb-1">
                       <span className="text-2xl">{status === 'correct' ? 'üéâ' : 'ü§î'}</span>
                       <span className={`font-bold ${status === 'correct' ? 'text-green-700' : 'text-red-700'}`}>
                          {status === 'correct' ? 'Ch√≠nh x√°c!' : 'Ch∆∞a ƒë√∫ng r·ªìi.'}
                       </span>
                    </div>
                    {status === 'incorrect' && (
                       <div className="text-gray-600 mt-1">
                          <p>ƒê√°p √°n ƒë√∫ng: <strong className="text-gray-800">{currentEx.answer}</strong></p>
                          {currentEx.type === 'error' && <p>S·ª≠a l·∫°i th√†nh: <strong>{currentEx.correction}</strong></p>}
                       </div>
                    )}
                    <p className="text-sm text-gray-500 mt-2 border-t border-gray-200/50 pt-2 italic">
                       Gi·∫£i th√≠ch: {currentEx.explanation}
                    </p>
                 </div>
               )}
            </div>

            {/* Footer Controls */}
            <div className="p-6 bg-white border-t border-gray-100 rounded-br-2xl flex gap-3">
               {status === 'idle' ? (
                 <>
                   <button onClick={handleNext} className="px-4 py-3 text-gray-400 font-bold hover:text-gray-600">B·ªè qua</button>
                   <button 
                     onClick={handleCheck}
                     disabled={currentEx.type === 'reorder' ? reorderUsedIndices.length === 0 : !userAnswer}
                     className="flex-1 px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none transition-all"
                   >
                     Ki·ªÉm tra
                   </button>
                 </>
               ) : (
                 <>
                   {status === 'incorrect' && (
                     <button onClick={handleRetry} className="px-6 py-3 border-2 border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50">
                       L√†m l·∫°i
                     </button>
                   )}
                   <button onClick={handleNext} className="flex-1 px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-md hover:bg-indigo-700 flex items-center justify-center gap-2">
                     C√¢u ti·∫øp theo <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                   </button>
                 </>
               )}
            </div>
          </div>
        );
      };

      // --- MAIN APP ---
      const App = () => {
        const [topic, setTopic] = useState("");
        const [lessonData, setLessonData] = useState(null);
        const [loading, setLoading] = useState(false);

        const handleStart = async () => {
          if (!topic.trim()) return;
          setLoading(true);
          try {
            const data = await generateGrammarLesson(topic);
            setLessonData(data);
          } catch (e) {
            alert("L·ªói: " + e.message + ". Vui l√≤ng ki·ªÉm tra API Key.");
          } finally {
            setLoading(false);
          }
        };

        // Welcome Screen
        if (!lessonData && !loading) {
          return (
            <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
              <div className="max-w-md w-full glass-panel rounded-3xl p-8 shadow-2xl text-center space-y-6">
                 <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto text-4xl shadow-inner">
                    üéì
                 </div>
                 <div>
                    <h1 className="text-3xl font-bold text-gray-800 mb-1">Grammar<span className="text-blue-600">Pro</span></h1>
                    <p className="text-gray-500">Tr·ª£ l√Ω ng·ªØ ph√°p th√¥ng minh c·ªßa b·∫°n</p>
                 </div>

                 <div className="space-y-3 text-left">
                    <label className="text-sm font-bold text-gray-600 ml-1">H√¥m nay em mu·ªën h·ªçc v·ªÅ g√¨?</label>
                    <input 
                      type="text" 
                      value={topic}
                      onChange={e => setTopic(e.target.value)}
                      placeholder="V√≠ d·ª•: Th√¨ hi·ªán t·∫°i ƒë∆°n, C√¢u ƒëi·ªÅu ki·ªán..."
                      className="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition-all text-lg font-medium text-gray-700 placeholder:font-normal"
                      onKeyDown={e => e.key === 'Enter' && handleStart()}
                    />
                 </div>

                 <button 
                   onClick={handleStart}
                   disabled={!topic.trim()}
                   className="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all disabled:opacity-50 disabled:hover:translate-y-0"
                 >
                   B·∫Øt ƒë·∫ßu b√†i h·ªçc üöÄ
                 </button>
                 
                 <div className="flex flex-wrap justify-center gap-2 mt-4">
                    {["Qu√° kh·ª© ƒë∆°n", "C√¢u b·ªã ƒë·ªông", "M·ªánh ƒë·ªÅ quan h·ªá"].map(tag => (
                      <button key={tag} onClick={() => setTopic(tag)} className="text-xs bg-white border border-gray-200 px-3 py-1 rounded-full text-gray-500 hover:border-blue-400 hover:text-blue-600 transition-colors">
                         {tag}
                      </button>
                    ))}
                 </div>
              </div>
            </div>
          );
        }

        // Loading Screen
        if (loading) {
          return (
             <div className="min-h-screen flex items-center justify-center bg-blue-50">
               <Loading />
             </div>
          );
        }

        // Main Learning Screen (Split View)
        return (
          <div className="h-screen flex flex-col bg-gray-100 overflow-hidden">
             {/* Navbar */}
             <header className="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-10 shrink-0">
                <div className="flex items-center gap-2 cursor-pointer" onClick={() => { if(confirm('Tho√°t b√†i h·ªçc?')) window.location.reload() }}>
                   <span className="text-2xl">üéì</span>
                   <span className="font-bold text-gray-700 text-lg hidden sm:block">GrammarPro</span>
                </div>
                <div className="bg-blue-50 text-blue-800 px-4 py-1.5 rounded-full font-bold text-sm truncate max-w-[200px]">
                   {lessonData.title}
                </div>
             </header>

             {/* Split Layout */}
             <main className="flex-1 p-2 md:p-4 grid grid-cols-1 md:grid-cols-2 gap-4 h-[calc(100vh-64px)] overflow-hidden">
                {/* Left: Theory */}
                <div className="h-full rounded-2xl shadow-sm overflow-hidden border border-gray-200">
                   <TheoryPanel data={lessonData} />
                </div>

                {/* Right: Practice */}
                <div className="h-full rounded-2xl shadow-sm overflow-hidden border border-gray-200 bg-white">
                   <ExercisePanel exercises={lessonData.exercises} />
                </div>
             </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>